{"version":3,"file":"learningmap.min.js","sources":["../src/learningmap.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Learningmap editor module\n *\n * @module     mod_learningmap/learningmap\n * @copyright  2025 ISB Bayern\n * @author     Stefan Hanauska <stefan.hanauska@csg-in.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {exception as displayException} from 'core/notification';\nimport Templates from 'core/templates';\nimport placestore from 'mod_learningmap/placestore';\nimport svgjs from 'mod_learningmap/svg';\nimport shapes from './shapes';\nimport emojipicker from 'core/emoji/picker';\n\n// Constants for updatePathDeclaration.\nconst targetPoints = {\n    firstPoint: 1,\n    secondPoint: 2,\n    bezierPoint: 3,\n};\n\nconst pathTypes = {\n    line: 1,\n    quadraticbezier: 2,\n};\n\nexport const init = () => {\n    // Load the needed template on startup for better execution speed.\n    Templates.prefetchTemplates(['mod_learningmap/cssskeleton']);\n\n    // Size for the new circles. This will be overriden by placesize from the placestore.\n    var circleRadius = 10;\n\n    // Variable for storing the mouse offset\n    var offset;\n\n    // Variable for draggable element\n    var dragel;\n\n    // Variables for storing the paths that need update of the first or\n    // the second coordinates.\n    var pathsToUpdateFirstPoint, pathsToUpdateSecondPoint;\n\n    // Variables for handling the currently selected elements\n    var selectedElement = null,\n        firstPlace = null,\n        secondPlace = null,\n        lastTarget = null;\n\n    // Variable for storing the selected element for the activity selector\n    var elementForActivitySelector = null;\n\n    // Variables for simulating double click on touch devices, set when the\n    // corresponding events are handled\n    var touchstart = false;\n    var touchend = false;\n    // Counter for touchmove events\n    var touchmove = 0;\n\n    // DOM nodes for the editor\n    let mapdiv = document.getElementById('learningmap-editor-map');\n    let code = document.getElementById('id_svgcode');\n\n    let svgdoc = new DOMParser().parseFromString(code.value, 'image/svg+xml');\n    let svgnode = svgdoc.querySelector('svg');\n\n    // DOM nodes for the activity selector\n    let activitySetting = document.getElementById('learningmap-activity-setting');\n    let activitySelector = document.getElementById('learningmap-activity-selector');\n    let activityStarting = document.getElementById('learningmap-activity-starting');\n    let activityTarget = document.getElementById('learningmap-activity-target');\n    let activityHiddenWarning = document.getElementById('learningmap-activity-hidden-warning');\n\n    // Hide tree view as there is no preview file we can attach to\n    let treeView = document.querySelector('.fp-viewbar .fp-vb-tree');\n    if (treeView) {\n        treeView.setAttribute('style', 'display: none;');\n    }\n\n    // Trigger click event on icon view to ensure that tree view is not active.\n    let iconView = document.querySelector('.fp-viewbar .fp-vb-icons');\n    if (iconView) {\n        // Handle possible delay in form loading.\n        setTimeout(() => {\n            iconView.dispatchEvent(new Event('click'));\n        }, 1000);\n    }\n\n    // Attach listeners to the activity selector\n    if (activitySelector) {\n        // Show places that are not linked to an activity\n        activitySelector.addEventListener('change', function() {\n            placestore.setActivityId(elementForActivitySelector, activitySelector.value);\n            if (activitySelector.value) {\n                let text = document.getElementById('text' + elementForActivitySelector);\n                if (text) {\n                    text.replaceChildren(svgdoc.createCDATASection(\n                        activitySelector.querySelector('option[value=\"' + activitySelector.value + '\"]').textContent\n                    ));\n                }\n                let title = document.getElementById('title' + elementForActivitySelector);\n                if (title) {\n                    title.replaceChildren(svgdoc.createCDATASection(\n                        activitySelector.querySelector('option[value=\"' + activitySelector.value + '\"]').textContent\n                    ));\n                }\n                document.getElementById(elementForActivitySelector).classList.remove('learningmap-emptyplace');\n            } else {\n                document.getElementById(elementForActivitySelector).classList.add('learningmap-emptyplace');\n            }\n            updateActivities();\n            updateCode();\n        });\n        // Add / remove a place to the starting places array\n        activityStarting.addEventListener('change', function() {\n            if (activityStarting.checked) {\n                placestore.addStartingPlace(elementForActivitySelector);\n            } else {\n                placestore.removeStartingPlace(elementForActivitySelector);\n            }\n            updateCode();\n        });\n        // Add / remove a place to the target places array\n        activityTarget.addEventListener('change', function() {\n            if (activityTarget.checked) {\n                placestore.addTargetPlace(elementForActivitySelector);\n                document.getElementById(elementForActivitySelector).classList.add('learningmap-targetplace');\n            } else {\n                placestore.removeTargetPlace(elementForActivitySelector);\n                document.getElementById(elementForActivitySelector).classList.remove('learningmap-targetplace');\n            }\n            updateCode();\n        });\n    }\n\n    // Load placestore values from the hidden input field\n    let placestoreInput = document.getElementsByName('placestore')[0];\n    if (placestoreInput) {\n        placestore.loadJSON(placestoreInput.value);\n    }\n\n    updateColorPickers();\n\n    // Mark all activities in the placestore as \"used\".\n    updateActivities();\n\n    // Initialize the menus.\n    initMenu('advanced-settings', [\n        {name: 'hidepaths', get: placestore.getHidePaths, set: placestore.setHidePaths},\n        {name: 'showall', get: placestore.getShowall, set: placestore.setShowall},\n        {name: 'slicemode', get: placestore.getSliceMode, set: placestore.setSliceMode},\n        {name: 'showwaygone', get: placestore.getShowWayGone, set: placestore.setShowWayGone},\n    ]);\n\n    initMenu('place-settings', [\n        {name: 'usecheckmark', get: placestore.getUseCheckmark, set: placestore.setUseCheckmark},\n        {name: 'hover', get: placestore.getHover, set: placestore.setHover},\n        {name: 'pulse', get: placestore.getPulse, set: placestore.setPulse},\n        {name: 'hidestroke', get: placestore.getHideStroke, set: placestore.setHideStroke},\n        {name: 'showtext', get: placestore.getShowText, set: placestore.setShowText, callback: fixPlaceLabels},\n        {name: 'placesize', get: placestore.getPlaceSize, set: placestore.setPlaceSize, callback: updatePlaceSize},\n        {name: 'placecolor', get: placestore.getPlaceColor, set: placestore.setPlaceColor},\n        {name: 'visitedcolor', get: placestore.getVisitedColor, set: placestore.setVisitedColor},\n        {name: 'strokecolor', get: placestore.getStrokeColor, set: placestore.setStrokeColor},\n        {name: 'textcolor', get: placestore.getTextColor, set: placestore.setTextColor},\n        {name: 'placeemoji', get: placestore.getPlaceEmoji, set: placestore.setPlaceEmoji},\n        {name: 'visitedemoji', get: placestore.getVisitedEmoji, set: placestore.setVisitedEmoji},\n    ]);\n\n    // Get SVG code from the (hidden) textarea field\n    if (code && mapdiv) {\n        mapdiv.replaceChildren(svgnode);\n    }\n    // Reload background image to get the correct width and height values\n    refreshBackgroundImage();\n    registerBackgroundListener();\n    updateCode();\n\n    // Enable dragging of places\n    let svgel = document.getElementById('learningmap-svgmap-' + placestore.getMapid());\n    makeDraggable(svgel);\n    var mapsvg = svgjs().SVG('#learningmap-svgmap-' + placestore.getMapid());\n\n    // Refresh stylesheet values from placestore\n    updateCSS();\n\n    // Add listeners for clicking and context menu\n    if (mapdiv) {\n        mapdiv.addEventListener('dblclick', dblclickHandler);\n        mapdiv.addEventListener('click', clickHandler);\n\n        mapdiv.addEventListener('contextmenu', function(e) {\n            e.preventDefault();\n            showContextMenu(e);\n        }, false);\n    }\n    /**\n     * Shows the context menu at the current mouse position\n     * @param {*} e\n     */\n    function showContextMenu(e) {\n        unselectAll();\n        hideOtherMenus();\n        // Check for the existence of the target (could have vanished since the event started).\n        if (activitySetting && document.getElementById(e.target.id) !== null) {\n            if (e.touches) {\n                e = e.touches[0];\n            }\n            if (e.target.classList.contains('learningmap-place')) {\n                let element = getSVGShape(e.target.id);\n                e.target.classList.add('learningmap-selected-activity-selector');\n                let activityId = placestore.getActivityId(e.target.id);\n                let scalingFactor = mapdiv.clientWidth / 800;\n                activitySetting.style.setProperty('--pos-x', element.cx() * scalingFactor + 'px');\n                activitySetting.style.setProperty('--pos-y', element.cy() * scalingFactor + 'px');\n                activitySetting.style.setProperty('--map-width', mapdiv.clientWidth + 'px');\n                activitySetting.style.setProperty('--map-height', mapdiv.clientHeight + 'px');\n                activitySetting.style.display = 'block';\n                document.getElementById('learningmap-activity-selector').value = activityId;\n                document.getElementById('learningmap-activity-starting').checked = placestore.isStartingPlace(e.target.id);\n                document.getElementById('learningmap-activity-target').checked = placestore.isTargetPlace(e.target.id);\n                elementForActivitySelector = e.target.id;\n                updateActivities();\n            } else {\n                hideContextMenu();\n                hideOtherMenus();\n            }\n        }\n    }\n\n    /**\n     * Hides the context menu\n     */\n    function hideContextMenu() {\n        let e = document.getElementById(elementForActivitySelector);\n        if (e) {\n            e.classList.remove('learningmap-selected-activity-selector');\n        }\n        activitySetting.style.display = 'none';\n    }\n\n    let backgroundfileNode = document.getElementById('id_backgroundfile_fieldset');\n    if (backgroundfileNode) {\n        let observer = new MutationObserver(refreshBackgroundImage);\n        observer.observe(backgroundfileNode, {attributes: true, childList: true, subtree: true});\n    }\n\n    /**\n     * Helper function for getting the right coordinates from the mouse\n     * @param {*} evt\n     * @returns {object}\n     */\n    function getMousePosition(evt) {\n        if (evt.touches) {\n            evt = evt.touches[0];\n        }\n        return transformCoordinates(evt.clientX, evt.clientY);\n    }\n\n    /**\n     * Transforms client coordinates to SVG coordinates\n     * @param {number} x x coordinate to transform\n     * @param {number} y y coordinate to transform\n     * @returns {object} Object containing transformed x and y coordinate\n     */\n    function transformCoordinates(x, y) {\n        var CTM = dragel.getScreenCTM();\n        return {\n            x: (x - CTM.e) / CTM.a,\n            y: (y - CTM.f) / CTM.d\n        };\n    }\n\n    /**\n     * Returns the SVG shape with the given id or representing the\n     * given object.\n     * @param {*} element\n     * @returns\n     */\n    function getSVGShape(element) {\n        if (typeof element === 'object') {\n            return mapsvg.findOne('#' + element.id);\n        } else {\n            return mapsvg.findOne('#' + element);\n        }\n    }\n\n    /**\n     * Enables dragging on an DOM node\n     * @param {*} el\n     */\n    function makeDraggable(el) {\n        dragel = el;\n        if (el) {\n            el.addEventListener('mousedown', startDrag);\n            el.addEventListener('mousemove', drag);\n            el.addEventListener('mouseup', endDrag);\n            el.addEventListener('mouseleave', endDrag);\n            el.addEventListener('touchstart', startTouch);\n            el.addEventListener('touchmove', drag);\n            el.addEventListener('touchend', endTouch);\n            el.addEventListener('touchleave', endTouch);\n            el.addEventListener('touchcancel', endTouch);\n        }\n\n        /**\n         * Function called whenn dragging starts.\n         * @param {*} evt\n         */\n        function startDrag(evt) {\n            if (evt.cancelable) {\n                evt.preventDefault();\n            }\n            pathsToUpdateFirstPoint = [];\n            pathsToUpdateSecondPoint = [];\n            if (evt.target.classList.contains('learningmap-draggable')) {\n                selectedElement = evt.target;\n                let svgel = getSVGShape(selectedElement);\n                offset = getMousePosition(evt);\n                offset.x -= svgel.cx();\n                offset.y -= svgel.cy();\n                // Get paths that need to be updated.\n                pathsToUpdateFirstPoint = placestore.getPathsWithFid(evt.target.id);\n                pathsToUpdateSecondPoint = placestore.getPathsWithSid(evt.target.id);\n            } else if (evt.target.nodeName == 'text') {\n                selectedElement = evt.target;\n                let svgel = getSVGShape(selectedElement);\n                let place = findPlaceForText(selectedElement.id);\n                offset = getMousePosition(evt);\n                offset.x -= svgel.attr('dx') + place.cx();\n                offset.y -= svgel.attr('dy') + place.cy();\n            } else if (evt.target.nodeName == 'path') {\n                selectedElement = evt.target;\n                offset = getMousePosition(evt);\n                let pathPoint = transformCoordinates(evt.layerX, evt.layerY);\n                offset.x += pathPoint.x;\n                offset.y += pathPoint.y;\n            }\n        }\n\n        /**\n         * Function called during dragging. Continuously updates places center coordinates and the\n         * coordinates of the touching paths.\n         * @param {*} evt\n         */\n        function drag(evt) {\n            if (evt.cancelable) {\n                evt.preventDefault();\n            }\n            // Count touchmove events\n            touchmove++;\n            if (selectedElement) {\n                var coord = getMousePosition(evt);\n                let cx = coord.x - offset.x;\n                let cy = coord.y - offset.y;\n                if (selectedElement.classList.contains('learningmap-place')) {\n                    let placeel = mapsvg.findOne('#' + selectedElement.id);\n                    placeel.center(cx, cy);\n                    let textNode = mapsvg.findOne('#text' + selectedElement.id);\n                    if (textNode !== null) {\n                        textNode.amove(cx, cy);\n                    }\n                    pathsToUpdateFirstPoint.forEach(function(path) {\n                        let pathElement = getSVGShape(path);\n                        if (pathElement !== null) {\n                            if (pathElement.type == 'path') {\n                                pathElement.attr(\n                                    {'d': updatePathDeclaration(pathElement.attr('d'), cx, cy, targetPoints.firstPoint)}\n                                );\n                            } else {\n                                pathElement.attr({'x1': cx, 'y1': cy});\n                            }\n                        }\n                    });\n\n                    pathsToUpdateSecondPoint.forEach(function(path) {\n                        let pathElement = getSVGShape(path);\n                        if (pathElement !== null) {\n                            if (pathElement.type == 'path') {\n                                pathElement.attr(\n                                    {'d': updatePathDeclaration(pathElement.attr('d'), cx, cy, targetPoints.secondPoint)}\n                                );\n                            } else {\n                                pathElement.attr({'x2': cx, 'y2': cy});\n                            }\n                        }\n                    });\n                } else if (selectedElement.nodeName == 'text') {\n                    let textel = getSVGShape(selectedElement);\n                    let place = findPlaceForText(selectedElement.id);\n                    // Calculate the delta from the current mouse position to the corresponding place.\n                    // coord: current mouse position\n                    // offset: delta from the mouse position to the coordinates of the text node\n                    let dx = cx - place.cx();\n                    let dy = cy - place.cy();\n                    // We cannot use the dx() and dy() functions of the text node, because they are not\n                    // setting the attributes dx and dy.\n                    textel.attr({dx: dx, dy: dy});\n                } else if (selectedElement.nodeName == 'path') {\n                    selectedElement.setAttribute(\n                        'd',\n                        updatePathDeclaration(selectedElement.getAttribute('d'), coord.x, coord.y, targetPoints.bezierPoint)\n                    );\n                }\n            }\n        }\n\n        /**\n         * Function called when dragging ends.\n         * @param {*} evt\n         */\n        function endDrag(evt) {\n            if (evt.cancelable) {\n                evt.preventDefault();\n            }\n            selectedElement = null;\n            unselectAll();\n            updateCode();\n        }\n\n        /**\n         * Function called when touchstart event occurs.\n         * @param {*} evt\n         */\n        function startTouch(evt) {\n            if (evt.cancelable) {\n                evt.preventDefault();\n            }\n            if (\n                evt.target.classList.contains('learningmap-draggable') ||\n                evt.target.nodeName == 'text' ||\n                evt.target.nodeName == 'path'\n            ) {\n                if (!touchstart) {\n                    touchstart = true;\n                    touchmove = 0;\n                    touchend = false;\n                    setTimeout(\n                        (evt) => {\n                            if (touchmove < 3 && !touchend) {\n                                if (evt.touches) {\n                                    evt = evt.touches[0];\n                                }\n                                showContextMenu(evt);\n                            }\n                        },\n                        2000,\n                        evt\n                    );\n                    setTimeout(\n                        () => {\n                            touchstart = false;\n                        },\n                    300);\n                } else {\n                    dblclickHandler(evt);\n                    touchstart = false;\n                }\n                startDrag(evt);\n            } else {\n                if (!touchstart) {\n                    touchstart = true;\n                    touchend = false;\n                    touchmove = 0;\n                    setTimeout(\n                        () => {\n                            touchstart = false;\n                        },\n                    300);\n                } else {\n                    dblclickHandler(evt);\n                    touchstart = false;\n                }\n            }\n        }\n\n        /**\n         * Function called when touchend, touchleave or touchcancel event occurs.\n         * @param {*} evt\n         */\n        function endTouch(evt) {\n            selectedElement = null;\n            touchend = true;\n            // If there was only a small move (<3 move events), this also counts as a click.\n            if (touchmove < 3 && touchstart) {\n                clickHandler(evt);\n            } else {\n                endDrag(evt);\n            }\n            if (evt.cancelable) {\n                evt.preventDefault();\n            }\n        }\n\n        /**\n         * Updates the path declaration of lines and quadratic bezier curves setting one of the points.\n         * @param {string} oldDefinition SVG path definition string\n         * @param {number} targetX x coordinate of the point to set\n         * @param {number} targetY y coordinate of the point to set\n         * @param {number} targetP Which point to change (you can use the targetPoints constants here)\n         * @returns {string} Updated SVG path definition\n         */\n        function updatePathDeclaration(oldDefinition, targetX, targetY, targetP = targetPoints.firstPoint) {\n            let parts = oldDefinition.split(' ');\n            let fromX = 0;\n            let fromY = 0;\n            let toX = 0;\n            let toY = 0;\n            let bezierX = 0;\n            let bezierY = 0;\n            let pathType = pathTypes.line;\n\n            // The d attribute of an SVG path in a learning map can have two different formats (in this version):\n            // \"M x1 y1 L x2 y2\"        Line from x1, y1 to x2, y2\n            // \"M x1 y2 Q x3 y3 x2 y2\"  Quadratic bezier curve inside the triangle defined by x1, y1, x2, y2 and x3, y3.\n            for (let i = 0; i < parts.length; i++) {\n                // Every path contains the first point in that way.\n                if (parts[i] == 'M') {\n                    fromX = parseInt(parts[i + 1]);\n                    fromY = parseInt(parts[i + 2]);\n                    i += 2;\n                }\n                // This path is a direct line, so there are only two points in total.\n                if (parts[i] == 'L') {\n                    toX = parseInt(parts[i + 1]);\n                    toY = parseInt(parts[i + 2]);\n                    i += 2;\n                }\n                // This path is a bezier curve, there are three points in total.\n                if (parts[i] == 'Q') {\n                    bezierX = parseInt(parts[i + 1]);\n                    bezierY = parseInt(parts[i + 2]);\n                    toX = parseInt(parts[i + 3]);\n                    toY = parseInt(parts[i + 4]);\n                    i += 4;\n                    pathType = pathTypes.quadraticbezier;\n                }\n            }\n\n            switch (targetP) {\n                case targetPoints.firstPoint:\n                    fromX = targetX;\n                    fromY = targetY;\n                    break;\n                case targetPoints.secondPoint:\n                    toX = targetX;\n                    toY = targetY;\n                    break;\n                case targetPoints.bezierPoint:\n                    // Calculate the third triangle point for the bezier curve.\n                    bezierX = targetX * 2 - (fromX + toX) * 0.5;\n                    bezierY = targetY * 2 - (fromY + toY) * 0.5;\n                    pathType = pathTypes.quadraticbezier;\n                    break;\n            }\n\n            if (pathType == pathTypes.quadraticbezier) {\n                return 'M ' + fromX + ' ' + fromY + ' Q ' + bezierX + ' ' + bezierY + ', ' + toX + ' ' + toY;\n            } else {\n                return 'M ' + fromX + ' ' + fromY + ' L ' + toX + ' ' + toY;\n            }\n        }\n    }\n\n    /**\n     * Updates the form fields for the SVG code and the placestore from the editor.\n     */\n    function updateCode() {\n        if (code && mapdiv) {\n            code.innerHTML = mapdiv.innerHTML;\n        }\n        if (placestoreInput) {\n            document.getElementsByName('placestore')[0].value = JSON.stringify(placestore.getPlacestore());\n        }\n    }\n\n    /**\n     * Handles double clicks on the map\n     * @param {*} event\n     */\n    function dblclickHandler(event) {\n        hideContextMenu();\n        hideOtherMenus();\n        unselectAll();\n        if (event.target.classList.contains('learningmap-mapcontainer') ||\n            event.target.classList.contains('learningmap-background-image')) {\n            addPlace(event);\n        } else if (event.target.classList.contains('learningmap-place')) {\n            if (lastTarget == event.target.id) {\n                lastTarget = null;\n                clickHandler(event);\n            } else {\n                removePlace(event);\n            }\n        } else if (event.target.classList.contains('learningmap-path')) {\n            removePath(event.target.id);\n        }\n        updateCode();\n    }\n\n    /**\n     * Returns an empty title tag with the given id.\n     * @param {*} id id for the title\n     * @returns {any}\n     */\n    function title(id) {\n        return mapsvg.element('title').id(id);\n    }\n\n    /**\n     * Returns an text tag with the given id.\n     * @param {*} id id for the text\n     * @param {*} content content of the tag\n     * @param {*} x x coordinate of the text\n     * @param {*} y y coordinate of the text\n     * @returns {any}\n     */\n     function text(id, content, x, y) {\n        return mapsvg.text().attr({dx: circleRadius * 1.5, dy: circleRadius * 1.5}).plain(content).move(x, y).id(id);\n    }\n\n    /**\n     * Returns a path between two points.\n     * @param {*} x1 x coordinate of the first point\n     * @param {*} y1 y coordinate of the first point\n     * @param {*} x2 x coordinate of the second point\n     * @param {*} y2 y coordinate of the second point\n     * @param {*} classes CSS classes to set\n     * @param {*} id id of the path\n     * @returns {any}\n     */\n     function path(x1, y1, x2, y2, classes, id) {\n        return mapsvg.path('M ' + x1 + ' ' + y1 + ' L ' + x2 + ' ' + y2).attr({'class': classes}).id(id);\n    }\n\n    /**\n     * Returns a link around a given child element. This function also adds a title element next\n     * to the child for accessibility.\n     * @param {*} child child item to set the link on\n     * @param {*} id id of the link\n     * @param {*} title title of the link\n     * @returns {any}\n     */\n    function link(child, id, title = null) {\n        return mapsvg.link('').id(id).add(child).add(title);\n    }\n\n    /**\n     * Adds a place on the SVG map. This function also prepares the code for linking activities\n     * and adding titles (for accessibility).\n     * @param {*} event event causing the command\n     */\n    function addPlace(event) {\n        let placesgroup = mapsvg.findOne('.learningmap-places-group');\n        let textgroup = mapsvg.findOne('.learningmap-text-group');\n        let placeId = 'p' + placestore.getId();\n        let linkId = 'a' + placestore.getId();\n        var CTM = event.target.getScreenCTM();\n        if (event.touches) {\n            event = event.touches[0];\n        }\n        let cx = (event.clientX - CTM.e) / CTM.a;\n        let cy = (event.clientY - CTM.f) / CTM.d;\n        let svglink = link(\n            shapes.circle(mapsvg, cx, cy, circleRadius, 'learningmap-place learningmap-draggable learningmap-emptyplace', placeId),\n            linkId,\n            title('title' + placeId)\n        );\n        svglink.addTo(placesgroup);\n        let textNode = text('text' + placeId, '', cx, cy);\n        textNode.addTo(textgroup);\n        placestore.addPlace(placeId, linkId, null, svglink.bbox());\n    }\n\n    /**\n     * Handles single clicks on the background image.\n     * @param {*} event click event\n     * @returns {void}\n     */\n    function clickHandler(event) {\n        event.preventDefault();\n        hideContextMenu();\n        hideOtherMenus();\n        if (event.target.classList.contains('learningmap-place') && selectedElement === null) {\n            if (firstPlace === null) {\n                firstPlace = event.target.id;\n                document.getElementById(firstPlace).classList.add('learningmap-selected');\n            } else {\n                secondPlace = event.target.id;\n                let fid = parseInt(firstPlace.replace('p', ''));\n                let sid = parseInt(secondPlace.replace('p', ''));\n                if (sid == fid) {\n                    return;\n                }\n                if (sid < fid) {\n                    let z = sid;\n                    sid = fid;\n                    fid = z;\n                }\n                addPath(fid, sid);\n                let first = document.getElementById(firstPlace);\n                if (first) {\n                    first.classList.remove('learningmap-selected');\n                }\n                firstPlace = null;\n                lastTarget = secondPlace;\n                secondPlace = null;\n            }\n        } else {\n            unselectAll();\n            firstPlace = null;\n        }\n    }\n    /**\n     * Removes the classes 'learningmap-selected' and 'learningmap-selectet-activity-selector'\n     * from all nodes\n     */\n    function unselectAll() {\n        Array.from(document.getElementsByClassName('learningmap-selected')).forEach(function(e) {\n            e.classList.remove('learningmap-selected');\n        });\n        Array.from(document.getElementsByClassName('learningmap-selected-activity-selector')).forEach(function(e) {\n            e.classList.remove('learningmap-selected-activity-selector');\n        });\n    }\n\n    /**\n     * Adds a path between two places.\n     * @param {number} fid id of the first place (meant to be the smaller one)\n     * @param {number} sid id of the second place (meant to be the bigger one)\n     */\n    function addPath(fid, sid) {\n        let pid = 'p' + fid + '_' + sid;\n        if (document.getElementById(pid) === null) {\n            let pathsgroup = mapsvg.findOne('.learningmap-pathsgroup');\n            let first = mapsvg.findOne('#p' + fid);\n            let second = mapsvg.findOne('#p' + sid);\n            if (pathsgroup && first && second) {\n                let svgpath = path(\n                    first.cx(),\n                    first.cy(),\n                    second.cx(),\n                    second.cy(),\n                    'learningmap-path',\n                    pid\n                );\n                svgpath.addTo(pathsgroup);\n                placestore.addPath(pid, 'p' + fid, 'p' + sid);\n            }\n        }\n    }\n\n    /**\n     * Removes a place from the SVG and the placestore. This function also removes all\n     * touching paths and entries in statringplaces / targetplaces linking to the removed\n     * place.\n     * @param {any} event event causing the remove order\n     */\n    function removePlace(event) {\n        let place = getSVGShape(event.target.id);\n        removePathsTouchingPlace(event.target.id);\n        placestore.removePlace(event.target.id);\n        place.parent().remove();\n        let textNode = document.getElementById('text' + event.target.id);\n        if (textNode) {\n            textNode.remove();\n        }\n\n        updateCode();\n    }\n\n    /**\n     * Removes all paths touching a certain place\n     * @param {number} id id of the place\n     */\n    function removePathsTouchingPlace(id) {\n        placestore.getTouchingPaths(id).forEach(\n            function(e) {\n                removePath(e.id);\n            }\n        );\n    }\n\n    /**\n     * Removes a path from the SVG and from the placestore\n     * @param {number} id id of the path\n     */\n    function removePath(id) {\n        let path = getSVGShape(id);\n        if (path !== null) {\n            path.remove();\n            placestore.removePath(id);\n        }\n    }\n\n    /**\n     * Sets the background image of the SVG to the current image in filemanager.\n     */\n    function refreshBackgroundImage() {\n        let previewimage = document.getElementsByClassName('realpreview');\n        if (previewimage.length > 0) {\n            let background = document.getElementById('learningmap-background-image');\n            let backgroundurl = previewimage[0].getAttribute('src').split('?')[0];\n            // If the uploaded file reuses the filename of a previously uploaded image, they differ\n            // only in the oid. So one has to append the oid to the url.\n            if (previewimage[0].getAttribute('src').split('?')[1].includes('&oid=')) {\n                backgroundurl += '?oid=' + previewimage[0].getAttribute('src').split('&oid=')[1];\n            }\n            background.setAttribute('xlink:href', backgroundurl);\n        }\n    }\n\n    /**\n     * Adds an eventListener to the background image for watching file changes and updating\n     * height and width of the image.\n     */\n    function registerBackgroundListener() {\n        let background = document.getElementById('learningmap-background-image');\n        if (background) {\n            background.addEventListener('load', function() {\n                background.removeAttribute('height');\n                let height = parseInt(background.getBBox().height);\n                let width = background.getBBox().width;\n                placestore.setBackgroundDimensions(width, height);\n                svgel.setAttribute('viewBox', '0 0 ' + placestore.width + ' ' + placestore.height);\n                background.setAttribute('width', width);\n                background.setAttribute('height', height);\n                updateCode();\n            });\n        }\n    }\n\n    /**\n     * Updates CSS code inside the SVG (called, when one of the colors is changed).\n     * Calls updateCode() when completed.\n     */\n    function updateCSS() {\n        Templates.renderForPromise('mod_learningmap/cssskeleton', placestore.getPlacestore())\n            .then(({html, js}) => {\n                Templates.replaceNode('#learningmap-svgstyle', html, js);\n                updateCode();\n                return true;\n            })\n            .catch(ex => displayException(ex));\n        let placestoretemp = placestore.getPlacestore();\n        placestoretemp.mapid = 'preview';\n        placestoretemp.cssid = 'learningmap-preview-svgstyle';\n        placestoretemp.editmode = false;\n        Templates.renderForPromise('mod_learningmap/cssskeleton', placestoretemp)\n            .then(({html, js}) => {\n                Templates.replaceNode('#learningmap-preview-svgstyle', html, js);\n                return true;\n            })\n            .catch(ex => displayException(ex));\n    }\n\n    /**\n     * Updates the activity selector to highlight the activities already used\n     * and to show the alert for hidden activities.\n     */\n    function updateActivities() {\n        let activities = placestore.getAllActivities();\n        let options = Array.from(activitySelector.getElementsByTagName('option'));\n        activityHiddenWarning.setAttribute('hidden', '');\n        options.forEach(function(n) {\n            if (activities.includes(n.value)) {\n                n.classList.add('learningmap-used-activity');\n                if (n.selected) {\n                    if (n.getAttribute('data-activity-hidden') == true) {\n                        activityHiddenWarning.removeAttribute('hidden');\n                    }\n                }\n            } else {\n                n.classList.remove('learningmap-used-activity');\n            }\n        });\n    }\n\n    /**\n     * Adds missing text nodes\n     */\n    function fixPlaceLabels() {\n        let options = Array.from(activitySelector.getElementsByTagName('option'));\n        let places = placestore.getPlaces();\n        let textgroup = mapsvg.findOne('.learningmap-text-group');\n        for (const place of places) {\n            if (document.getElementById('text' + place.id) === null) {\n                let content = '';\n                for (const option of options) {\n                    if (option.value == place.linkedActivity) {\n                        content = option.textContent;\n                        break;\n                    }\n                }\n                let placeNode = mapsvg.findOne('#' + place.id);\n                let textNode = text('text' + place.id, content, placeNode.cx(), placeNode.cy());\n                textNode.addTo(textgroup);\n            } else {\n                let textNode = mapsvg.findOne('#text' + place.id);\n                textNode.addTo(textgroup);\n            }\n        }\n    }\n\n    /**\n     * Updates the size of the places.\n     */\n    function updatePlaceSize() {\n        circleRadius = placestore.getPlaceSize();\n        let places = placestore.getPlaces();\n        for (const place of places) {\n            let placeel = getSVGShape(place.id);\n            if (placeel) {\n                let cx = placeel.cx();\n                let cy = placeel.cy();\n                if (placeel.type != 'text') {\n                    placeel.width(circleRadius * 2).height(circleRadius * 2);\n                } else {\n                    placeel.font({size: circleRadius});\n                }\n                placeel.center(cx, cy);\n            }\n        }\n    }\n\n    /**\n     * Initializes a menu with the given features.\n     * @param {*} name Name of the menu\n     * @param {*} features Array with features to add to the menu\n     */\n    function initMenu(name, features) {\n        let icon = document.getElementById('learningmap-' + name + '-icon');\n        if (icon) {\n            icon.addEventListener('click', function(event) {\n                event.preventDefault();\n                if (menuIsHidden(name)) {\n                    showMenu(name);\n                    hideOtherMenus(name);\n                } else {\n                    hideMenu(name);\n                }\n            });\n            let close = document.getElementById('learningmap-' + name + '-close');\n            if (close) {\n                close.addEventListener('click', function() {\n                    hideMenu(name);\n                });\n            }\n        }\n        features.forEach(function(feature) {\n            menuItemLogic(name, feature.name, feature.get, feature.set, feature.callback, feature.second);\n        });\n    }\n\n    /**\n     * Returns whether the menu is hidden or not.\n     * @param {*} name Name of the menu\n     * @returns {boolean}\n     */\n    function menuIsHidden(name) {\n        let menu = document.getElementById('learningmap-' + name + '-menu');\n        if (menu) {\n            return menu.getAttribute('hidden') !== null;\n        }\n        return false;\n    }\n\n    /**\n     * Hides the menu with the given name.\n     * @param {*} name Name of the menu\n     */\n    function hideMenu(name) {\n        let menu = document.getElementById('learningmap-' + name + '-menu');\n        if (menu) {\n            menu.setAttribute('hidden', 'hidden');\n        }\n    }\n\n    /**\n     * Hides all menus except the one with the given name.\n     * @param {*} name Name of the menu not to hide\n     */\n    function hideOtherMenus(name = '') {\n        let otherMenus = document.querySelectorAll('.learningmap-menu');\n        otherMenus.forEach(function(menu) {\n            if (menu.id != 'learningmap-' + name + '-menu') {\n                menu.setAttribute('hidden', 'hidden');\n            }\n        });\n    }\n\n    /**\n     * Shows the menu with the given name.\n     * @param {*} name Name of the menu\n     */\n    function showMenu(name) {\n        let menu = document.getElementById('learningmap-' + name + '-menu');\n        if (menu) {\n            menu.removeAttribute('hidden');\n            updateColorPickers();\n            hideOtherMenus(name);\n            hideContextMenu();\n        }\n    }\n\n    /**\n     * Adds the event listener to menu items\n     * @param {*} type Type of the item (describes the menu where it is located, e.g. advanced-settings, place-settings, ...)\n     * @param {*} name Name of the item\n     * @param {*} getCall Method of placestore to call to read value\n     * @param {*} setCall Method of placestore to call to save value\n     * @param {*} callback Additional callback after value is saved\n     */\n    function menuItemLogic(type, name, getCall, setCall, callback = null) {\n        let menuItem = document.getElementById('learningmap-' + type + '-' + name);\n        if (menuItem) {\n            switch (menuItem.attributes.type.nodeValue) {\n                case 'checkbox':\n                    menuItem.checked = getCall.call(placestore);\n                    menuItem.addEventListener('input', function() {\n                        setCall.call(placestore, menuItem.checked);\n                        if (callback !== null) {\n                            callback();\n                        }\n                        updateCSS();\n                    });\n                break;\n                default:\n                    menuItem.value = getCall.call(placestore);\n                    menuItem.addEventListener('input', function() {\n                        setCall.call(placestore, menuItem.value);\n                        if (callback !== null) {\n                            callback();\n                        }\n                        updateCSS();\n                    });\n            }\n\n        }\n    }\n\n    /**\n     * Updates the color pickers to the current values from the placestore.\n     */\n    function updateColorPickers() {\n        let colorPickers = document.querySelectorAll('[id^=\"learningmap-place-settings-jscolor-\"]');\n        colorPickers.forEach(function(colorpicker) {\n            if (colorpicker.jscolor) {\n                colorpicker.jscolor.fromString(placestore[colorpicker.id.split('jscolor-')[1]]);\n            }\n        });\n    }\n\n    /**\n     * Returns the place that belongs to the given text id.\n     * @param {*} textId\n     * @returns\n     */\n    function findPlaceForText(textId) {\n        let placename = textId.replace('text', '');\n        return mapsvg.findOne('#' + placename);\n    }\n};\n"],"names":["targetPoints","pathTypes","prefetchTemplates","offset","dragel","pathsToUpdateFirstPoint","pathsToUpdateSecondPoint","circleRadius","selectedElement","firstPlace","secondPlace","lastTarget","elementForActivitySelector","touchstart","touchend","touchmove","mapdiv","document","getElementById","code","svgdoc","DOMParser","parseFromString","value","svgnode","querySelector","activitySetting","activitySelector","activityStarting","activityTarget","activityHiddenWarning","treeView","setAttribute","iconView","setTimeout","dispatchEvent","Event","addEventListener","setActivityId","text","replaceChildren","createCDATASection","textContent","title","classList","remove","add","updateActivities","updateCode","checked","addStartingPlace","removeStartingPlace","addTargetPlace","removeTargetPlace","placestoreInput","getElementsByName","loadJSON","updateColorPickers","initMenu","name","get","placestore","getHidePaths","set","setHidePaths","getShowall","setShowall","getSliceMode","setSliceMode","getShowWayGone","setShowWayGone","getUseCheckmark","setUseCheckmark","getHover","setHover","getPulse","setPulse","getHideStroke","setHideStroke","getShowText","setShowText","callback","options","Array","from","getElementsByTagName","places","getPlaces","textgroup","mapsvg","findOne","place","id","content","option","linkedActivity","placeNode","cx","cy","addTo","getPlaceSize","setPlaceSize","placeel","getSVGShape","type","width","height","font","size","center","getPlaceColor","setPlaceColor","getVisitedColor","setVisitedColor","getStrokeColor","setStrokeColor","getTextColor","setTextColor","getPlaceEmoji","setPlaceEmoji","getVisitedEmoji","setVisitedEmoji","refreshBackgroundImage","background","removeAttribute","parseInt","getBBox","setBackgroundDimensions","svgel","registerBackgroundListener","getMapid","el","startDrag","drag","endDrag","evt","cancelable","preventDefault","target","contains","nodeName","dblclickHandler","touches","showContextMenu","endTouch","getMousePosition","x","y","getPathsWithFid","getPathsWithSid","findPlaceForText","attr","pathPoint","transformCoordinates","layerX","layerY","coord","textNode","amove","forEach","path","pathElement","updatePathDeclaration","textel","dx","dy","getAttribute","unselectAll","clickHandler","oldDefinition","targetX","targetY","targetP","parts","split","fromX","fromY","toX","toY","bezierX","bezierY","pathType","i","length","makeDraggable","SVG","e","hideOtherMenus","element","activityId","getActivityId","scalingFactor","clientWidth","style","setProperty","clientHeight","display","isStartingPlace","isTargetPlace","hideContextMenu","updateCSS","backgroundfileNode","MutationObserver","observe","attributes","childList","subtree","clientX","clientY","CTM","getScreenCTM","a","f","d","innerHTML","JSON","stringify","getPlacestore","event","placesgroup","placeId","getId","linkId","svglink","child","link","shapes","circle","addPlace","bbox","getTouchingPaths","removePath","removePlace","parent","plain","move","fid","replace","sid","z","pid","pathsgroup","first","second","x1","y1","x2","y2","classes","addPath","getElementsByClassName","previewimage","backgroundurl","includes","renderForPromise","then","_ref","html","js","replaceNode","catch","ex","placestoretemp","mapid","cssid","editmode","_ref2","activities","getAllActivities","n","selected","features","icon","menu","menuIsHidden","hideMenu","showMenu","close","feature","getCall","setCall","menuItem","nodeValue","call","menuItemLogic","otherMenus","querySelectorAll","colorpicker","jscolor","fromString","textId","placename"],"mappings":"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"}